# CURSOR AI RULES — Симуляция Радиатора (radiator-thermal)

> Прочитай этот файл целиком перед любым изменением кода.
> Каждый раздел предотвращает конкретный класс ошибок.

---

## 0. ФИЛОСОФИЯ

- Меняй **только** то, о чём попросили
- Перед правкой прочти **весь** затрагиваемый файл, не только указанный фрагмент
- Видишь проблему вне задачи — сообщи словами, не правь молча
- Если что-то неоднозначно — уточни, не угадывай

---

## 1. СТРУКТУРА ПРОЕКТА

```
main.ts        — точка входа, gameLoop, UI-обработчики, save/load
draw.ts        — вся отрисовка на Canvas (трубы, краны, радиатор, частицы)
physics.ts     — тепловая модель (ε-NTU, Ньютон-Рафсон)
hydraulics.ts  — гидравлика (сопротивление, потоки, стояк)
constants.ts   — ВСЕ константы и геометрия (L)
state.ts       — мутабельное состояние (экспортируется как * as st)
particle.ts    — класс Particle
types.ts       — TypeScript-интерфейсы
```

### Правила зависимостей:
- `draw.ts` импортирует только `constants` и `state` — так и должно быть
- `physics.ts` / `hydraulics.ts` — без новых DOM-зависимостей
- Не добавляй новые зависимости между модулями без причины

---

## 2. ГЕОМЕТРИЯ CANVAS И ОБЪЕКТ `L`

`L` из `constants.ts` — единственный источник правды по координатам.
Никогда не хардкоди числа если они уже есть в `L`.

```typescript
// НЕПРАВИЛЬНО:
drawHP(300, someY - 10, 1240, 20, 'hot');

// ПРАВИЛЬНО:
drawHP(L.radStartX, L.inletY - ph / 2, L.radEndX - L.radStartX, ph, 'hot');
```

### Ключевые координаты:

| Константа | Что это |
|-----------|---------|
| `L.bypassX` | X байпаса (120) |
| `L.bypassW` | Ширина байпаса (12) |
| `L.valveX` | X шаровых кранов (255) |
| `L.pipeH` | Толщина трубы в px (20) |
| `L.radStartX` | Начало радиатора |
| `L.radEndX` | Конец радиатора |
| `L.inletY` | Y-центр горячей трубы (подача, снизу) |
| `L.outletY` | Y-центр холодной трубы (обратка, сверху) |
| `L.secTopY` | Верх секций радиатора |
| `L.secBotY` | Низ секций радиатора |

**Важно:** `L.inletY`, `L.outletY`, `L.secTopY`, `L.secBotY` — это `get`-свойства.
Их значение меняется при перемещении радиатора (`updateRadiatorLayout`).
Не кешируй их вне функций рисования.

---

## 3. ФУНКЦИИ РИСОВАНИЯ ТРУБ

### Горизонтальная труба — `drawHP`

```typescript
drawHP(x, y, w, h, type, cornerRadius?)
// type: 'hot' | 'cold'
// Градиент сверху вниз (3D-цилиндрический эффект горизонтальной трубы)
```

### Вертикальная труба — `drawVP`

```typescript
drawVP(x, y, w, h, type)
// type: 'hot' | 'cold'
// Градиент слева направо (3D-цилиндрический эффект вертикальной трубы)
// Идентичный стиль с drawHP — для единообразия всех участков
```

### КРИТИЧЕСКОЕ ПРАВИЛО: Все трубные участки — только прямоугольниками

**Никогда не используй `arcTo` + `lineTo`-пути для трубных участков.**
Это создаёт треугольные/трапециевидные скосы на угловых переходах.

```typescript
// НЕПРАВИЛЬНО — даёт скос на угловом переходе:
ctx.beginPath();
ctx.moveTo(x, y);
ctx.arcTo(x + w, y, x + w, y + h, r);
ctx.lineTo(...);
ctx.closePath();
ctx.fill();

// ПРАВИЛЬНО — два прямоугольника, соединённых встык (угол перекрывается):
drawVP(0, L.outletY - ph / 2 - ext, ph, ext + ph, 'cold');  // вертикаль + угол (ph×ph)
drawHP(ph, L.outletY - ph / 2, L.bypassX - gap - ph, ph, 'cold');  // горизонталь
```

### Схема разметки труб (при `leftPipeExt > 0`):

```
Стена → вертикаль → угол → горизонталь → байпас → горизонталь → кран → радиатор
  x=0     drawVP    (в drawVP)  drawHP              drawHP         drawHP
```

---

## 4. СОСТОЯНИЕ (`state.ts`)

Всё глобальное состояние — в `state.ts`. Импортируй как `import * as st from './state'`.

```typescript
st.mode          // 'bad' | 'good'
st.leftPipeExt   // выдвижение труб влево от стены (px)
st.thermal       // тепловые данные (температуры, мощности, потоки)
st.balance       // баланс (T_room_eq, итерации сходимости)
st.flowData      // распределение потоков по секциям

// Изменение — только через setter-функции:
st.setLeftPipeExt(120);  // ✅
```

Не добавляй поля напрямую в `st.thermal` / `st.balance` — обновляй через `Object.assign` в `physics.ts`.

---

## 5. КОНСТАНТЫ

Всё — в `constants.ts`. Не хардкоди числа в других файлах.

| Константа | Значение | Назначение |
|-----------|----------|-----------|
| `SECTIONS` | 10 | Число секций радиатора |
| `COLD_THRESHOLD` | 30°C | Граница «холодной» воды |
| `FREEZE_THRESHOLD` | 2.0°C | Замерзание секции |
| `THAW_THRESHOLD` | 5.0°C | Размораживание секции |
| `MIN_FLOW_EPS` | 1e-7 | Ноль расхода |
| `NEWTON_MAX_ITER` | 100 | Итерации Ньютона |

---

## 6. ТЕПЛОВАЯ МОДЕЛЬ (physics.ts)

```
ε-NTU:
  NTU = hA / (G × Cp)
  ε   = 1 − exp(−NTU)
  Q   = ε × G × Cp × (T_sup − T_room)
  T_ret = T_sup − Q / (G × Cp)

Равновесие: Q_рад = Q_потерь → Ньютон-Рафсон по T_room
```

`calcQradAtTroom` — чистая функция, не трогает состояние кроме `frozenSections`.
`findEquilibriumTroom` — запускает полный расчёт, вызывается из `main.ts`.

---

## 7. ЧАСТИЦЫ (particle.ts)

Анимация, **не влияет на физику**. Состояния:
```
enter → to_rad → to_sec_up → rise → top_coll → exit → reset
              ↘ byp_up ↗
```

---

## 8. ЗАПРЕЩЕНО

```
❌ arcTo/lineTo-пути для рисования трубных участков (→ треугольные скосы)
❌ Хардкодить координаты вместо L.bypassX, L.inletY, L.pipeH и т.д.
❌ Прямая мутация st.thermal / st.balance вне physics.ts
❌ Импорт draw.ts в physics.ts или hydraulics.ts
❌ console.log в продакшн-коде (только временная отладка)
❌ Изменять SECTIONS без проверки всех массивов
❌ Создавать новый файл, если логика вписывается в существующий
```

---

## 9. КАК ДОБАВИТЬ НОВЫЙ ВИЗУАЛЬНЫЙ ЭЛЕМЕНТ В draw.ts

```typescript
function drawMyElement(x: number, y: number): void {
  st.ctx.save();
  // 1. Тень: fillStyle='rgba(0,0,0,0.08)', fillRect(x+2, y+2, w, h)
  // 2. createLinearGradient + fill
  // 3. stroke
  st.ctx.restore();  // ← обязательно
}
// Градиент горизонтальных элементов: сверху вниз
// Градиент вертикальных элементов: слева направо
```

---

## 10. ЗАПУСК

```bash
npm run dev   # → http://localhost:5173
```

Открытие `index.html` через `file://` не работает — ES-модули требуют сервера.

---

## 11. ЧЕКЛИСТ ПЕРЕД ОТПРАВКОЙ

```
[ ] Прочитан весь затрагиваемый файл, не только изменённый фрагмент
[ ] Координаты берутся из L, не захардкожены
[ ] Трубные участки рисуются через drawHP/drawVP (не arcTo-пути)
[ ] ctx.save() / ctx.restore() в каждой новой функции рисования
[ ] Изменение не затрагивает ничего лишнего
[ ] Нет console.log
```

---

*Проект: radiator-thermal — симуляция теплового баланса однотрубного радиатора*
*Стек: TypeScript + Vite + Canvas 2D API*
